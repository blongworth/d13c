---
title: "Untitled"
output: html_document
---

TODO:

* Join with process tables to get d13C qty, etc.

Some questions:

* Do the data in mass_spec match those in the process tables?
* Does irms sample size affect precision or ratio?
* How should we eliminate outliers to get at the precision and accuracy of d13C?
* What samples should we use to estimate IRMS precision and accuracy?
* What samples should we use to estimate the same for the entire process?
* What can d13C tell us about fractionation in sample prep processes?

```{r}
library(tidyverse)
library(amstools)
library(DBI)
library(skimr)
```

Create a database connection, and a dbplyr connection to mass_spec

```{r}
con <- conNOSAMS()
mass_spec <- tbl(con, "mass_spec")
head(mass_spec)
str(mass_spec)
```

Join to standards table to select data with a consensus value

```{r}
standards <- tbl(con, "standards")
head(standards)

standards
d13c_data <- inner_join(mass_spec, standards) %>% 
  select(rec_num, ms_date, sample_id, d13_cons, "d13_meas" = c13_cr_1std, beam_size, mass_spec)

head(d13c_data)

tally(d13c_data)
skim(d13c_data)
```


Check the data. Does mass_spec match what's in the process tables?

```{r}
d13c_data %>% 
  filter(ms_date > "2020-01-01") %>% 
  head()
```

Having trouble finding standards by rec_num. Maybe a problem with the join to create mass_spec?

```{r}
d13c_data %>% 
  group_by(rec_num) %>%
  filter(n() > 100) %>% 
  summarize("d13C mean" = mean(d13_meas),
            "d13C sd" = sd(d13_meas),
            N = n()) %>% 
  gt::gt()
  
```

Look at histogram of beam size

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001) %>%
  ggplot(aes(beam_size)) + geom_histogram()
```

Plot INST3 GAS

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         sample_desc == "INST3 GAS",
         c13_cr_3std < 0) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```

Check NBS-19

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         sample_desc %like% "NBS-19",
         c13_cr_3std < 10) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```

Check C-2

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         rec_num == 1082,
         c13_cr_3std > -7.5) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```

NOSAMS-2
```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         rec_num == 38809,
         c13_cr_3std > -7.5) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```

Check C-1

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         rec_num == 1081,
         c13_cr_3std > -7.5) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```