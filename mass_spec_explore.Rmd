---
title: "Untitled"
output: html_document
---

TODO:

* Join with process tables to get d13C qty, etc.

Some questions:

* Do the data in mass_spec match those in the process tables?
* Does irms sample size affect precision or ratio?
* How should we eliminate outliers to get at the precision and accuracy of d13C?
* What samples should we use to estimate IRMS precision and accuracy?
* What samples should we use to estimate the same for the entire process?
* What can d13C tell us about fractionation in sample prep processes?

```{r}
library(tidyverse)
library(amstools)
library(DBI)
library(skimr)
library(gt)
```

Create a database connection, and a dbplyr connection to mass_spec

```{r}
con <- conNOSAMS()
mass_spec <- tbl(con, "mass_spec")
head(mass_spec)
str(mass_spec)
```

Join to standards table to select data with a consensus value

```{r}
standards <- tbl(con, "standards")

d13c_data <- inner_join(mass_spec, standards) %>% 
  select(rec_num, ms_date, sample_id, d13_cons, 
         "d13_meas" = c13_cr_1std, beam_size, mass_spec) %>%
  collect() 

d13c_data <- d13c_data %>% 
  group_by(rec_num) %>% 
  filter(!is.na(d13_meas)) %>% 
  mutate(outlier = is.na(removeOutliers(d13_meas))) %>% 
  ungroup()

head(d13c_data)

tally(d13c_data)
skim(d13c_data)
```


Standards by rec num, outliers removed

```{r}
d13c_data %>% 
  group_by(rec_num) %>%
  filter(n() > 100,
         outlier == FALSE) %>% 
  summarize(Name = first(sample_id),
            "d13C mean" = mean(d13_meas),
            "d13C sd" = sd(d13_meas),
            N = n()) %>% 
  arrange(desc(N))
```

Try eliminating outliers using IQR

```{r}

```

# Beam size vs precision/accuracy

Look at histogram of beam size

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001) %>%
  ggplot(aes(beam_size)) + geom_histogram()
```

Plot INST3 GAS

```{r}
inst3gas <- mass_spec %>% 
  filter(sample_desc == "INST3 GAS",
         c13_cr_3std < 0) %>% 
  mutate(outlier = is.na(removeOutliers(d13_meas)))

inst3gas %>% 
  summarize
  

  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```

Check NBS-19

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         sample_desc %like% "NBS-19",
         c13_cr_3std < 10) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```

Check C-2

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         rec_num == 1082,
         c13_cr_3std > -7.5) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```

NOSAMS-2
```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         rec_num == 38809,
         c13_cr_3std > -7.5) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```

Check C-1

```{r}
mass_spec %>% 
  filter(beam_size > 0,
         beam_size < 0.001,
         rec_num == 1081,
         c13_cr_3std > -7.5) %>%
  ggplot(aes(beam_size, c13_cr_1std)) + 
           geom_point()
```