---
title: "d13c precision"
output:
  html_document:
    df_print: paged
---

This notebook looks at historical d13C data for known-value samples. The intent is to look at the precision and accuracy of d13C over time.

## Initial goals

* Estimate the overall precision of d13C analysis at NOSAMS
* Investigate changes in precision over time
* Is there a difference between the Optima and Prism
* Is there a difference by sample type
* How does sample size affect precision and accuracy?


## Data

Initially, we can use the standards dataset that I generate daily. I suspect we'll need to add additional fields (instrument, etc...). We'll also need a custom query to pull older data to look at changes in d13C data since the lab started.

Where's best for the datasets we use? I prefer to keep data off of github, so maybe depositing the data on the share drive and importing it to people's local folders? Alternatively, if people are set up to access the NOSAMS DB, we can use a script to update data.

## Initial exploration

load libraries

```{r}
library(amstools)
library(tidyverse)
library(skimr)
library(odbc)
```

So, let's start from rec_nums that are in the standards table, and then pull relevant corresponding data from the process tables. This has been transferred to get_d13c_data.R...


```{r}
load("data/NOSAMS_d13c.rda")

skim(data)

unique(data$irms)

ggplot(data, aes(date, d13c)) +
  geom_point()

data %>%
ggplot(aes(name, d13c)) +
  geom_boxplot()

mostrun <- data %>%
  group_by(rec_num) %>%
  filter(n() > 1000)

mostrun %>%
  group_by(rec_num, name) %>%
  summarize(mean = mean(d13c),
            sd = sd(d13c))

ggplot(mostrun, aes(name, d13c)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
ggplot(mostrun, aes(date, d13c)) +
  geom_point() +
  facet_wrap(vars(name))
```

Looking for something we've run for a long time...

What's that sample at -10 permil?

```{r}
  data %>% filter(d13c > -11, d13c < -9) %>%
  group_by(rec_num, name) %>%
  summarise(n())
```

Some randos, but mostly 17185, which is TIRI-I. I'll come back and look at the flyers later- maybe mislabels?


```{r}
tirii <- data %>%
  filter(rec_num == 17185)

skim(tirii)
```

```{r}
ggplot(tirii, aes(date, d13c)) +
  geom_point()
```

Without outliers...

```{r}
ggplot(tirii, aes(date, d13c, color = irms)) +
  geom_point() +
  ylim(-13, -7)

tirii <- tirii %>%
  filter( irms == "O" | irms == "P")

tirii_no <- tirii %>%
  filter(!is.na(removeOutliers(d13c)))
        
  
tirii %>%
  summarize(d13c.m = mean(d13c),
            s13c.sd = sd(d13c))

tirii_no %>%
  summarize(d13c.m = mean(d13c),
            s13c.sd = sd(d13c))

tirii_no %>%
  ggplot(aes(date, d13c, color = irms)) +
    geom_point() 
```

Is there a difference by instrument?

```{r}
tirii_no %>%
  group_by(irms) %>%
  summarize(d13c.m = mean(d13c),
            s13c.sd = sd(d13c))

t.test(d13c ~ irms, data = tirii)
anova(lm(d13c ~ irms, data = tirii))
```

Let's look at 149823, an OX-I gas.

```{r}
filter(data, rec_num == 149823) %>%
ggplot(aes(date, d13c)) +
  geom_point()
```

Clearly a few outliers.  Given the ratios, I think they're mislabels or something. Let's remove them and those really early points and get a mean and sd.

```{r}
data %>%
  filter(rec_num == 149823,
         date > "2019-01-01",
         d13c < -15,
         d13c > -20) %>%
  summarize(d13c.m = mean(d13c),
          d13c.sd = sd(d13c))
```

0.06 permil. Not bad.

Let's try and look at all the OX-I bulbs. I'm lazy so I'm doing this by 13C rather than by picking OX-I rec_nums.

```{r}
data %>%
  ggplot(aes(date, d13c, color = as.factor(rec_num))) +
           geom_jitter()
```

Well, that's not going to work. How about picking rec_nums with a consensus fm of 1.0398 (ox-I).

```{r}

oxstd <- standards %>%
  filter(fm_consensus == 1.0398) %>%
  select(rec_num)

ox <- data %>%
  filter(rec_num %in% oxstd$rec_num)

ox %>%
  ggplot(aes(date, d13c, color = as.factor(rec_num))) +
           geom_jitter()
```

And the summary for all things that are supposed to be OX-I

```{r}
ox %>%
  summarize(d13c.m = mean(d13c),
          d13c.sd = sd(d13c))

```

Might be better to look at this by rec_num.

```{r}
ox %>%
  ggplot(aes(as.factor(rec_num), d13c, color = as.factor(irms))) +
           geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
  
ox %>%
  group_by(rec_num, irms) %>%
  summarize(d13c.m = mean(d13c),
          d13c.sd = sd(d13c))
  
```

## Organics

Let's do the same for OX-I solid. Really, I just need to write something to get all the data at once.

```{r}

```


# Get data from files

Pausing on getting 13C data from DB for a minute. Al's spreadsheet irms data are available on the share drive.

```{r}
dir <- file.path("//fileshare.whoi.edu/whoi/dept/gg/nosams/arg/")
```

